{% comment %}
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  EMERSON BY AVERY â€” CUSTOMER FAVORITES
  Premium product grid with hover effects and quick add
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{% endcomment %}

{{ 'section-emerson-products.css' | asset_url | stylesheet_tag }}

<section 
  class="emerson-products"
  data-section-id="{{ section.id }}"
  style="--section-bg: {{ section.settings.bg_color }};"
>
  <div class="emerson-products__container">
    <!-- Section Header -->
    <div class="emerson-section-header" data-animate="fade-up">
      <div>
        {%- if section.settings.tag != blank -%}
          <span class="emerson-section-tag">{{ section.settings.tag }}</span>
        {%- endif -%}
        {%- if section.settings.heading != blank -%}
          <h2 class="emerson-section-title">{{ section.settings.heading }}</h2>
        {%- endif -%}
        {%- if section.settings.subheading != blank -%}
          <p class="emerson-section-subtitle">{{ section.settings.subheading }}</p>
        {%- endif -%}
      </div>
      {%- if section.settings.view_all_link != blank -%}
        <a href="{{ section.settings.view_all_link }}" class="emerson-section-link">
          {{ section.settings.view_all_text | default: 'View all products' }}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
          </svg>
        </a>
      {%- endif -%}
    </div>

    <!-- Products Grid -->
    <div class="emerson-products__grid">
      {%- assign collection = collections[section.settings.collection] -%}
      {%- assign products_to_show = section.settings.products_count | default: 4 -%}
      
      {%- if collection != blank and collection.products.size > 0 -%}
        {%- for product in collection.products limit: products_to_show -%}
          <div class="emerson-product-card" data-animate="fade-up" data-delay="{{ forloop.index }}">
            <a href="{{ product.url }}" class="emerson-product-card__link">
              <div class="emerson-product-card__media">
                {%- if product.metafields.custom.badge != blank -%}
                  <span class="emerson-product-badge emerson-product-badge--{{ product.metafields.custom.badge_type | default: 'bestseller' }}">
                    {{ product.metafields.custom.badge }}
                  </span>
                {%- elsif forloop.first -%}
                  <span class="emerson-product-badge emerson-product-badge--bestseller">Bestseller</span>
                {%- endif -%}
                
                <button class="emerson-product-wishlist" type="button" aria-label="Add to wishlist">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                  </svg>
                </button>
                
                <div class="emerson-product-image">
                  {%- if product.featured_image != blank -%}
                    {{ product.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', class: 'emerson-product-img' }}
                  {%- else -%}
                    <span class="emerson-product-emoji">ğŸ¨</span>
                  {%- endif -%}
                </div>
                
                {%- if product.images.size > 1 -%}
                  <div class="emerson-product-image-hover">
                    {{ product.images[1] | image_url: width: 600 | image_tag: loading: 'lazy', class: 'emerson-product-img' }}
                  </div>
                {%- endif -%}
              </div>
              
              <div class="emerson-product-card__info">
                <h3 class="emerson-product-title">{{ product.title }}</h3>
                <div class="emerson-product-price">
                  {%- if product.compare_at_price > product.price -%}
                    <span class="emerson-product-price__current">{{ product.price | money }}</span>
                    <span class="emerson-product-price__compare">{{ product.compare_at_price | money }}</span>
                  {%- else -%}
                    <span class="emerson-product-price__current">{{ product.price | money }}</span>
                  {%- endif -%}
                </div>
              </div>
            </a>
            
            {%- if product.available -%}
              <button 
                class="emerson-quick-add"
                type="button"
                data-product-id="{{ product.variants.first.id }}"
                aria-label="Add {{ product.title }} to cart"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Quick Add
              </button>
            {%- else -%}
              <button class="emerson-quick-add emerson-quick-add--soldout" disabled>
                Sold Out
              </button>
            {%- endif -%}
          </div>
        {%- endfor -%}
      {%- else -%}
        <!-- Placeholder products when no collection selected -->
        {%- for i in (1..4) -%}
          <div class="emerson-product-card" data-animate="fade-up" data-delay="{{ forloop.index }}">
            <a href="#" class="emerson-product-card__link">
              <div class="emerson-product-card__media" style="background: linear-gradient(135deg, var(--emerson-primary)15, var(--emerson-primary)30);">
                {%- if forloop.first -%}
                  <span class="emerson-product-badge emerson-product-badge--bestseller">Bestseller</span>
                {%- elsif forloop.index == 3 -%}
                  <span class="emerson-product-badge emerson-product-badge--new">New</span>
                {%- elsif forloop.index == 4 -%}
                  <span class="emerson-product-badge emerson-product-badge--sale">Sale</span>
                {%- endif -%}
                
                <button class="emerson-product-wishlist" type="button" aria-label="Add to wishlist">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                  </svg>
                </button>
                
                <div class="emerson-product-image">
                  {%- case forloop.index -%}
                    {%- when 1 -%}<span class="emerson-product-emoji">ğŸŒˆ</span>
                    {%- when 2 -%}<span class="emerson-product-emoji">â˜€ï¸</span>
                    {%- when 3 -%}<span class="emerson-product-emoji">ğŸŒ³</span>
                    {%- when 4 -%}<span class="emerson-product-emoji">âœ¨</span>
                  {%- endcase -%}
                </div>
                
                <div class="emerson-product-image-hover">
                  <span class="emerson-product-emoji">âœ¨</span>
                </div>
              </div>
              
              <div class="emerson-product-card__info">
                <h3 class="emerson-product-title">
                  {%- case forloop.index -%}
                    {%- when 1 -%}Rainbow Heart Tote Bag
                    {%- when 2 -%}Happy Sun Note Cards (8-Pack)
                    {%- when 3 -%}Purple Tree Fine Art Print
                    {%- when 4 -%}Imagination Ceramic Mug
                  {%- endcase -%}
                </h3>
                <div class="emerson-product-price">
                  {%- if forloop.index == 4 -%}
                    <span class="emerson-product-price__current">$18.00</span>
                    <span class="emerson-product-price__compare">$22.00</span>
                  {%- else -%}
                    <span class="emerson-product-price__current">
                      {%- case forloop.index -%}
                        {%- when 1 -%}$28.00
                        {%- when 2 -%}$18.00
                        {%- when 3 -%}$35.00
                      {%- endcase -%}
                    </span>
                  {%- endif -%}
                </div>
              </div>
            </a>
            
            <button class="emerson-quick-add" type="button">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Quick Add
            </button>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>
  </div>
</section>

<script>
  (function() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;

    // Animation Observer
    const observerOptions = { threshold: 0.15, rootMargin: '0px 0px -80px 0px' };
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
        }
      });
    }, observerOptions);

    section.querySelectorAll('[data-animate]').forEach(el => observer.observe(el));

    // Quick Add functionality
    section.querySelectorAll('.emerson-quick-add[data-product-id]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const variantId = btn.dataset.productId;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="emerson-quick-add__loading">Adding...</span>';
        
        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: variantId, quantity: 1 })
          });
          
          if (response.ok) {
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Added!';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }, 2000);
          } else {
            throw new Error('Failed to add');
          }
        } catch (error) {
          btn.innerHTML = 'Error';
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "â­ Customer Favorites",
  "tag": "section",
  "class": "section-emerson-products",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "tag",
      "label": "Tag",
      "default": "Best Sellers"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Customer Favorites"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "The pieces our customers can't stop talking about. Each one hand-picked for spreading joy."
    },
    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Products to show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Link"
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View all text",
      "default": "View all products"
    },
    {
      "type": "url",
      "id": "view_all_link",
      "label": "View all link"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#FFFFFF"
    }
  ],
  "presets": [
    {
      "name": "â­ Customer Favorites"
    }
  ]
}
{% endschema %}