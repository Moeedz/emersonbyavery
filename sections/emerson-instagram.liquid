{% comment %}
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  EMERSON BY AVERY â€” INSTAGRAM FEED
  Real Instagram integration via access token
  Supports Instafeed.js or direct Instagram Basic Display API
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{% endcomment %}

{{ 'section-emerson-instagram.css' | asset_url | stylesheet_tag }}

<section 
  class="emerson-instagram"
  data-section-id="{{ section.id }}"
  data-access-token="{{ section.settings.access_token }}"
  data-posts-count="{{ section.settings.posts_count | default: 6 }}"
  style="--section-bg: {{ section.settings.bg_color }};"
>
  <div class="emerson-instagram__container">
    <!-- Header -->
    <div class="emerson-instagram__header" data-animate="fade-up">
      {%- if section.settings.eyebrow != blank -%}
        <span class="emerson-section-eyebrow">{{ section.settings.eyebrow }}</span>
      {%- endif -%}
      {%- if section.settings.heading != blank -%}
        <h2 class="emerson-section-title">{{ section.settings.heading }}</h2>
      {%- endif -%}
      {%- if section.settings.instagram_handle != blank -%}
        <a href="https://instagram.com/{{ section.settings.instagram_handle | remove: '@' }}" target="_blank" rel="noopener" class="emerson-instagram__handle">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="2" width="20" height="20" rx="5"/>
            <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/>
            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
          </svg>
          {{ section.settings.instagram_handle }}
        </a>
      {%- endif -%}
    </div>

    <!-- Instagram Grid -->
    <div class="emerson-instagram__grid" id="instafeed-{{ section.id }}">
      {%- if section.settings.access_token == blank -%}
        <!-- Placeholder images when no token configured -->
        {%- assign placeholder_colors = 'FFE4E8,FFF5E6,E8F4E8,E8EEF8,F8E8F8,FFF8E8' | split: ',' -%}
        {%- assign placeholder_emojis = 'ğŸŒˆ,â˜€ï¸,ğŸŒ³,âœ¨,ğŸ’–,ğŸ¨' | split: ',' -%}
        
        {%- for i in (0..5) -%}
          <div class="emerson-instagram__item emerson-instagram__item--placeholder" data-animate="zoom-in" data-delay="{{ forloop.index }}">
            <div class="emerson-instagram__item-bg" style="background: linear-gradient(135deg, #{{ placeholder_colors[i] }}, #{{ placeholder_colors[i] }}DD);">
              {{ placeholder_emojis[i] }}
            </div>
            <div class="emerson-instagram__item-overlay">
              <span class="emerson-instagram__item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="2" width="20" height="20" rx="5"/>
                  <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/>
                  <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
                </svg>
              </span>
            </div>
          </div>
        {%- endfor -%}
      {%- endif -%}
    </div>

    {%- if section.settings.access_token == blank -%}
      <!-- Setup instructions (only visible in editor) -->
      <div class="emerson-instagram__setup">
        <p><strong>To connect your Instagram:</strong></p>
        <ol>
          <li>Generate an access token at <a href="https://developers.facebook.com/docs/instagram-basic-display-api/getting-started" target="_blank">Facebook Developer Portal</a></li>
          <li>Or use a service like <a href="https://www.instafeedjs.com/" target="_blank">Instafeed.js Token Generator</a></li>
          <li>Paste your token in the section settings</li>
        </ol>
      </div>
    {%- endif -%}

    {%- if section.settings.button_text != blank -%}
      <div class="emerson-instagram__cta" data-animate="fade-up">
        <a 
          href="https://instagram.com/{{ section.settings.instagram_handle | remove: '@' }}" 
          target="_blank" 
          rel="noopener" 
          class="emerson-btn emerson-btn--secondary"
        >
          {{ section.settings.button_text }}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
            <polyline points="15 3 21 3 21 9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
        </a>
      </div>
    {%- endif -%}
  </div>
</section>

<script>
  (function() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;

    // Animation Observer
    const observerOptions = { threshold: 0.15, rootMargin: '0px 0px -80px 0px' };
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('in-view');
        }
      });
    }, observerOptions);

    section.querySelectorAll('[data-animate]').forEach(el => observer.observe(el));

    // Instagram Feed Integration
    const accessToken = section.dataset.accessToken;
    const postsCount = parseInt(section.dataset.postsCount) || 6;
    const grid = document.getElementById('instafeed-{{ section.id }}');
    
    if (accessToken && accessToken.trim() !== '') {
      fetchInstagramFeed(accessToken, postsCount, grid);
    }

    async function fetchInstagramFeed(token, limit, container) {
      try {
        const response = await fetch(
          `https://graph.instagram.com/me/media?fields=id,caption,media_type,media_url,thumbnail_url,permalink&limit=${limit}&access_token=${token}`
        );
        
        if (!response.ok) throw new Error('Failed to fetch Instagram feed');
        
        const data = await response.json();
        
        if (data.data && data.data.length > 0) {
          container.innerHTML = '';
          
          data.data.forEach((post, index) => {
            if (post.media_type === 'IMAGE' || post.media_type === 'CAROUSEL_ALBUM') {
              const item = createInstagramItem(post, index);
              container.appendChild(item);
            } else if (post.media_type === 'VIDEO' && post.thumbnail_url) {
              const item = createInstagramItem({
                ...post,
                media_url: post.thumbnail_url
              }, index);
              container.appendChild(item);
            }
          });
          
          // Animate new items
          container.querySelectorAll('[data-animate]').forEach(el => observer.observe(el));
        }
      } catch (error) {
        console.error('Instagram feed error:', error);
      }
    }

    function createInstagramItem(post, index) {
      const item = document.createElement('a');
      item.href = post.permalink;
      item.target = '_blank';
      item.rel = 'noopener';
      item.className = 'emerson-instagram__item';
      item.dataset.animate = 'zoom-in';
      item.dataset.delay = (index % 6) + 1;
      
      item.innerHTML = `
        <img 
          src="${post.media_url}" 
          alt="${post.caption ? post.caption.substring(0, 100) : 'Instagram post'}"
          loading="lazy"
          class="emerson-instagram__img"
        />
        <div class="emerson-instagram__item-overlay">
          <span class="emerson-instagram__item-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="5"/>
              <path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
            </svg>
          </span>
        </div>
      `;
      
      return item;
    }
  })();
</script>

{% schema %}
{
  "name": "ğŸ“¸ Instagram Feed",
  "tag": "section",
  "class": "section-emerson-instagram",
  "settings": [
    {
      "type": "header",
      "content": "Instagram Connection"
    },
    {
      "type": "text",
      "id": "access_token",
      "label": "Instagram Access Token",
      "info": "Generate at developers.facebook.com or use instafeedjs.com token generator"
    },
    {
      "type": "text",
      "id": "instagram_handle",
      "label": "Instagram handle",
      "default": "@emersonbyavery"
    },
    {
      "type": "range",
      "id": "posts_count",
      "label": "Number of posts",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 6
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow",
      "default": "Follow Along"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Join Our Creative Journey"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Follow on Instagram"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#FFFFFF"
    }
  ],
  "presets": [
    {
      "name": "ğŸ“¸ Instagram Feed"
    }
  ]
}
{% endschema %}